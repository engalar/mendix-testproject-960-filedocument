// This file was generated by Mendix Studio Pro.
//
// WARNING: Only the following code will be retained when actions are regenerated:
// - the import list
// - the code between BEGIN USER CODE and END USER CODE
// - the code between BEGIN EXTRA CODE and END EXTRA CODE
// Other code you write will be lost the next time you deploy the project.
// Special characters, e.g., é, ö, à, etc. are supported in comments.

package databasereplication.actions;

import com.mendix.core.Core;
import com.mendix.core.CoreException;
import com.mendix.core.objectmanagement.member.MendixObjectReferenceSet;
import com.mendix.systemwideinterfaces.core.IContext;
import com.mendix.systemwideinterfaces.core.IMendixIdentifier;
import com.mendix.webui.CustomJavaAction;
import com.mendix.systemwideinterfaces.core.IMendixObject;
import databasereplication.implementation.DBUpdateSettings;
import databasereplication.implementation.ObjectBaseDBSettings;
import databasereplication.proxies.Database;

/**
 * Using this Java action you can push multiple objects to the external database all within the same database connection.
 * 
 * The functionality is identical to the UpdateByMapping microflow, except the action will setup a single connection and try to merge the insert & update queries if possible. 
 */
public class UpdateByMapping_UsingUpdateSet extends CustomJavaAction<java.lang.Boolean>
{
	private IMendixObject __Mapping;
	private databasereplication.proxies.TableMapping Mapping;
	private IMendixObject __UpdateSetObject;
	private databasereplication.proxies.UpdateSet UpdateSetObject;
	private IMendixObject __UpdateConfig;
	private databasereplication.proxies.UpdateConfiguration UpdateConfig;

	public UpdateByMapping_UsingUpdateSet(IContext context, IMendixObject Mapping, IMendixObject UpdateSetObject, IMendixObject UpdateConfig)
	{
		super(context);
		this.__Mapping = Mapping;
		this.__UpdateSetObject = UpdateSetObject;
		this.__UpdateConfig = UpdateConfig;
	}

	@java.lang.Override
	public java.lang.Boolean executeAction() throws Exception
	{
		this.Mapping = __Mapping == null ? null : databasereplication.proxies.TableMapping.initialize(getContext(), __Mapping);

		this.UpdateSetObject = __UpdateSetObject == null ? null : databasereplication.proxies.UpdateSet.initialize(getContext(), __UpdateSetObject);

		this.UpdateConfig = __UpdateConfig == null ? null : databasereplication.proxies.UpdateConfiguration.initialize(getContext(), __UpdateConfig);

		// BEGIN USER CODE
		if( this.Mapping == null )
			throw new CoreException("Please provide a valid mapping");
		if( this.Mapping == null )
			throw new CoreException("Please provide an object to send to the other database");
		
		IContext context = this.getContext();
		Database CurDatabase = this.Mapping.getTableMapping_Database(context);
		ObjectBaseDBSettings dbSettings = new ObjectBaseDBSettings( context, CurDatabase.getMendixObject() );
		
		
		DBUpdateSettings settings = UpdateByMapping.setupUpdateSettings(context,this.Mapping, this.UpdateConfig, dbSettings);
		
		for( MendixObjectReferenceSet refSet : this.__UpdateSetObject.getReferenceSets(context) ) {
			
			for( IMendixIdentifier id : refSet.getValue(context) ) {
				IMendixObject obj = Core.retrieveId(context, id);
				UpdateByMapping.doDatabaseUpdate(dbSettings, obj, settings);
			}
		}
		

		return true;
		// END USER CODE
	}

	/**
	 * Returns a string representation of this action
	 */
	@java.lang.Override
	public java.lang.String toString()
	{
		return "UpdateByMapping_UsingUpdateSet";
	}

	// BEGIN EXTRA CODE
	// END EXTRA CODE
}
